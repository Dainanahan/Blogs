---
title: "Journey to the Center of DrugBank XML"
author: "Mohammed Ali, Ali Ezzat"
date: "December 31, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.tree)
```

## Objective
We will try to take a journey together to explore the wonders of *DrugBank* xml database. How the drugs information structured in different ways inside it and how we can retrive these information using **R**. So our purpose is to show how to parse the database and not to be overwhelmed with the domain information. Let us begin.

## What is DrugBank database
The DrugBank database is a comprehensive, freely accessible, online database containing information on drugs and drug targets.As both a bioinformatics and a cheminformatics resource, DrugBank combines detailed drug (i.e. chemical, pharmacological and pharmaceutical) data with comprehensive drug target (i.e. sequence, structure, and pathway) information [Wikipedia](https://en.wikipedia.org/wiki/DrugBank) and it is in *XML* format.


## Do you remember your children names
Each drug in the database is represented by `drug` node which contains beside its associated attributes many children which differ in name, functionality and more importantly to us *structure*. Let us take a peak:

```{r drug_sructure, echo=FALSE}
drug <- Node$new("Drug")
drug$AddChild("Drugbank Id(s)")
drug$AddChild("Name")
drug$AddChild("description")
drug$AddChild("Groups")
drug$AddChild("References")
drug$AddChild("synonyms")
drug$AddChild("products")
drug$AddChild("mixtures")
drug$AddChild("categories")
drug$AddChild("Many others ...")
plot(drug)
```

Wow that is a lot of children that different in format, size (grand children) beside each drug attributes too. 
We will start by parsing drug nodes then see how to deal with its children.

### drug node parser
Here we created a function that takes an *XML* rescord as an input and will see how we can extract direct children (that has no grand children) and the drug attributes.
We will use `purrr` and `XML` packages as follow:
* `tibble` <- construct a `tibble` structure contains the drug record information.
* `xmlValue` <- Gets the value of given children.
* `xmlGetAttr` <- Gets given xml node given attribute value.

```{r drug_node_parser, eval=FALSE}
# Extract drug df
drug_df <- function(rec) {
  tibble(
    # Each drug has 3 keys to be identified with
    # the primary key is the main key and must be exist
    # the other two keys are optional that is why we
    # are checking for them before parsing
    primary_key = xmlValue(rec["drugbank-id"][[1]]),
    secondary_key = ifelse(length(rec["drugbank-id"]) > 1, xmlValue(rec["drugbank-id"][[2]]), NA),
    third_key = ifelse(length(rec["drugbank-id"]) > 2, xmlValue(rec["drugbank-id"][[3]]), NA),
    
    type = xmlGetAttr(node = rec, name = "type"),
    created = as.Date(xmlGetAttr(node = rec, name = "created")),
    updated = as.Date(xmlGetAttr(node = rec, name = "updated")),
    name = xmlValue(rec[["name"]]),
    description = xmlValue(rec[["description"]]),
    cas_number = xmlValue(rec[["cas-number"]]),
    unii = xmlValue(rec[["unii"]]),
    state = xmlValue(rec[["state"]])
    ## Getting other attributes
  )
}
```


Then to get the values of all drug nodes using the above function we call `map_df` that will return a complete dataframe (tibble) object of given drugs. It takes two parameters:
* `drugbank$children` --> *XML* tree object for drug bank database
* `drug_df` -> the method we created above 

```{r drug_node_all, eval=FALSE}
# '~' is telling map_df that we are sending the function
# a dynamic parameter that is based on its first parameter
drugs <- map_df(drugbank$children, ~drug_df(.x))
```

